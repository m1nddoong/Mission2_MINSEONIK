# 사용자 인증 및 권한 처리

<details>
<summary>요구 사항 체크 ✔️</summary>
<div markdown="1">

- ✅ 요청을 보낸 사용자가 누구인지 구분할 수 있는 인증 체계가 갖춰져야 한다. 
    - ✅ ️JWT 기반의 토큰 인증 방식이 권장된다.
    - ✅ 사용자는 별도의 클라이언트를 통해 아이디와 비밀번호를 전달한다.
    - ✅ 로그인 URL로 아이디와 비밀번호가 전달되면, 해당 내용의 정당성을 확인하여 JWT를 발급하여 클라이언트에게 반환한다.
    - ✅ 클라이언트는 이후 이 JWT를 Bearer Authentication 방식으로 제시해야 한다.


- ✅ 사용자는 회원가입이 가능하다.
  - ✅ 아이디, 비밀번호를 제공하여 회원가입이 가능하다.
  - ✅ 서비스를 이용하려면 닉네임, 이름, 연령대, 이메일, 전화번호 정보를 추가해야 한다.
  - ✅ 사용자의 프로필 이미지가 업로드 가능하다.


- ✅ 사용자의 권한이 관리되어야 한다.
  - ✅️ 네 종류의 사용자가 있다. (비활성 사용자, 일반 사용자, 사업자 사용자, 관리자)
  - ✅ 최초의 회원가입시 비활성 사용자로 가입된다.
  - ✅ 비활성 사용자가 서비스를 위한 필수 정보를 추가하면 일반 사용자로 자동으로 전환된다.
  - ✅ 일반 사용자는 자신의 사업자 등록번호(가정)을 전달해 사업자 사용자로 전환신청을 할 수 있다.
    - ✅ 사업자 등록번호는 실제 형식과 일치할 필요 없다.
  - ✅ 관리자는 사업자 사용자 전환 신청 목록을 확인할 수 있다.
  - ✅ 관리자는 사업자 사용자 전환 신청을 수락 또는 거절할 수 있다.
  - ✅ 관리자는 서비스와 상관없이 고정된 사용자이다.
    - ✅ 다른 회원가입 과정을 통해 만들어진 사용자는 관리자가 될 수 없다.

</div>
</details>




## JWT 발급, 검증

세션과 JWT 간단한 비교
- 세션
  - HTML 폼 기반의 로그인 페이지를 사용하여 인증을 처리하는 경우
- JWT
  - Restful API 통신에서의 인증 방식
  - 토큰에 사용자 인증 및 권한 정보 외에도 Claim 을 통한 사용자 정보를 포함시킬 수 있다.

JWT 발급
- `JwtTokenUtils.java`
  - JWT 토큰 생성에 사용되는 메서드를 포함하는 유틸리티 클래스
  - 주로 사용자의 인증 정보를 바탕으로 JWT 토큰을 생성하는데 사용된다.
  - generateToken() 메서드는 UserDetails 객체를 입력으로 받아 해당 사용자를 나타내는 JWT 토큰을 생성한다.
  
JWT를 이용한 인증 - Bearer Token 인증 방식
- JWT 를 비롯한 토큰을 활용해서 인증을 진행할 경우, HTTP 요청을 보낼 때 Authorization Header 에  `Bearer {token 값}` 의 형태로 추가해 보내게 된다.
- 즉 서버에서는 들어온 HTTP 요청에 Authorization 이라는 헤더가 존재하는지, 존재한다면 거기에 담긴 값이 Bearer 로 시작하는지, 그리고 담겨있는 Token 이 유효한지 판단하는 JwtFilter 를 만들어야한다.
  - JWT 유효한지 알아보는 메서드 : `JwtTokenUtils.validate()`
  - `OncePerRequestFilter` 추상클래스로 필터 구현 : 사용자가 포함시킨 JWT의 유효성을 확인하고 Spring Security의 필터를 사용하여 사용자가 인증되었는지 여부를 판단

## ROLE

